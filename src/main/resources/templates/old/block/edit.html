<!--

    Skill Circuits
    Copyright (C) 2025 - Delft University of Technology

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

-->
<!DOCTYPE html>
<html
    lang="en"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
    <form
        th:if="${canEdit}"
        layout:fragment="header"
        data-edit="only"
        class="block__header"
        action="javascript:void(0);">
        <input name="id" th:value="${block.id}" type="hidden" />
        <input
            th:data-initial="${block.name}"
            class="font_size_bigger font_bold"
            data-edit="only"
            type="text"
            aria-label="Name"
            name="name"
            th:value="${block.name}"
            style="max-width: 20rem"
            required />
        <select
            th:data-initial="${group.id}"
            class="selectbox font_size_regular"
            data-edit="only"
            th:id="|edit-block-${block.id}-group|"
            aria-label="Group"
            th:name="|${groupType}.id|"
            required>
            <option
                data-edit="only"
                th:each="g : ${circuit.groups}"
                th:selected="${g.id == group.id}"
                th:value="${g.id}"
                th:text="${g.name}"></option>
        </select>

        <th:block th:if="${levelSvelte == 'module'}">
            <div id="create-skill-checkpoint" data-edit="only" th:if="${create}">
                <select
                    class="selectbox font_size_regular"
                    data-edit="only"
                    th:id="create-skill-checkpoint-select"
                    name="checkpoint.id">
                    <option
                        data-edit="only"
                        value="new"
                        th:id="create-skill-checkpoint-new"
                        th:val="new"
                        th:text="New..."></option>
                    <option
                        data-edit="only"
                        th:each="checkpoint: ${circuit.checkpointsInEdition}"
                        th:id="|create-skill-checkpoint-option-${checkpoint.id}|"
                        th:value="${checkpoint.id}"
                        th:text="${checkpoint.name}"
                        th:data-deadline="${checkpoint.deadline}"></option>
                </select>
                <input
                    data-edit="only"
                    th:id="create-skill-checkpoint-input"
                    th:name="checkpointCreate.name"
                    type="hidden" />
                <input
                    data-edit="only"
                    id="create-skill-checkpoint-deadline"
                    name="checkpointCreate.deadline"
                    type="hidden"
                    th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')+'T'+#dates.format(#dates.createNow(), 'HH:mm')}" />
            </div>
            <input
                id="create-skill-checkpoint-edition"
                name="checkpointCreate.edition.id"
                type="hidden"
                th:value="${circuit.edition.id}" />
        </th:block>

        <div data-edit="only" th:if="${levelSvelte == 'module'}">
            <input
                data-edit="only"
                th:data-initial="${block.essential}"
                type="checkbox"
                th:id="|essential-checkbox-${block.id}|"
                name="essential"
                value="true"
                th:checked="${block.essential}" />
            <span data-edit="only">
                <label data-edit="only" th:for="|essential-checkbox-${block.id}|">Essential</label>
                <span data-edit="only" class="info_icon">
                    <sup data-edit="only" class="fa-solid fa-info-circle"></sup>
                    <span data-edit="only" class="info_icon__text">
                        Mark optional materials as non-essential.
                    </span>
                </span>
            </span>
        </div>

        <div data-edit="only" th:if="${levelSvelte == 'module'}">
            <input
                data-edit="only"
                type="checkbox"
                th:data-initial="${block.hidden}"
                th:id="|hidden-checkbox-${block.id}|"
                name="hidden"
                value="true"
                th:checked="${block.hidden}" />
            <span data-edit="only">
                <label data-edit="only" th:for="|hidden-checkbox-${block.id}|">Hidden</label>
                <span data-edit="only" class="info_icon">
                    <sup data-edit="only" class="fa-solid fa-info-circle"></sup>
                    <span data-edit="only" class="info_icon__text">
                        This skill will not be displayed until a configurable set of tasks has been
                        completed.
                    </span>
                </span>
            </span>
        </div>

        <th:block th:if="${levelSvelte == 'module'}">
            <button
                class="button"
                th:classappend="${block.hidden} ? '' : 'hidden'"
                name="select-tasks"
                type="button"
                data-edit="only"
                th:text="${block.requiredTaskIds.isEmpty()} ? 'Select tasks' : (${block.requiredTaskIds.size() == 1} ? '1 task selected' : ${block.requiredTaskIds.size() + ' tasks selected'})"></button>
            <input
                type="hidden"
                name="requiredTaskIds"
                th:with="ids = ${block.requiredTaskIds.toString()}"
                th:data-initial="${ids.substring(1, ids.length()-1)}"
                th:value="${ids.substring(1, ids.length()-1)}" />
        </th:block>
    </form>

    <script th:if="${canEdit}" layout:fragment="script">
        function editBlock() {
            const block = $(this).parent().parent();
            const current = block.data("editing") === true;
            block.data("editing", !current);
            block.attr("data-editing", !current);
            block.attr("draggable", current);

            block.find(".item > a").each((i, link) => {
                $(link).after($(link).children());
            });
        }

        function cancelEditOrCreateBlock() {
            const block = $(this).parent().parent();
            if (block.data("create")) {
                cancelCreateBlock(block);
            } else {
                cancelEditBlock(block);
            }
        }
        function cancelEditBlock(block) {
            block.data("editing", false);
            block.attr("data-editing", false);
            block.attr("draggable", true);

            // Note: To include choice tasks, always select both item class and task class

            const deleted = block.find(".item[data-delete='true'], .task[data-delete='true']");
            deleted.attr("data-delete", false);
            deleted.data("delete", false);
            deleted.removeClass("hidden");
            block.find("input").prop("disabled", false);
            block.find("select").attr("data-disabled", false);
            $(`#${block.attr("id")} input:not([type="hidden"])`).each((i, field) =>
                $(field).val($(field).data("initial"))
            );
            $(`#${block.attr("id")} select`).each((i, field) =>
                $(field).val($(field).data("initial")).change()
            );
            block
                .find("input[type='checkbox']")
                .each((i, checkbox) => $(checkbox).prop("checked", $(checkbox).data("initial")));

            if (block.data("hidden") === true) {
                block.find("[name='requiredTaskIds']").each((i, requiredTasks) => {
                    const initialTasks = JSON.parse(`[${$(requiredTasks).data("initial")}]`);
                    $(requiredTasks).val(initialTasks);
                    if (initialTasks.length >= 1) {
                        let number = initialTasks.length ? "task" : "tasks";
                        $(requiredTasks)
                            .siblings("[name='select-tasks']")
                            .text(`${initialTasks.length} ${number} selected`);
                    } else {
                        $(requiredTasks).siblings("[name='select-tasks']").text("Select tasks");
                    }
                });
            }

            // Remove all item separations
            block.find(".item__separation").remove();

            // Move tasks out of newly created choice tasks
            block.find(".choice_task[data-new='true'] .task").each(function () {
                $(block.find(".items")[1]).append($(this).detach());
            });

            // Remove all new items
            block.find(".item[data-new='true'], .task[data-new='true']").remove();

            // Re-order the items and item separations

            // Append the upper item separation, if there is at least one task
            if (block.find(".item, .task").length > 0) {
                $(block.find(".items")[1]).append(createTaskSeparation());
            }

            // Add upper levelSvelte items (items not in choice tasks)
            const notInChoiceTaskStr = ":not([data-in-choice-task-initial='true'])";
            const upperLevelItems = block
                .find(`.item${notInChoiceTaskStr}, .task${notInChoiceTaskStr}`)
                .sort((itemA, itemB) => {
                    // Reverse ordering by index
                    return (
                        Number($(itemB).data("indexInitial")) -
                        Number($(itemA).data("indexInitial"))
                    );
                });
            upperLevelItems.each((_, item) => {
                addItemBackToItemList(item, block.find(".items")[1]);
            });

            // Add lower levelSvelte items (items in choice tasks)
            const choiceTasks = block.find(".choice_task");
            choiceTasks.each((_, choiceTask) => {
                const itemList = $(choiceTask).find(".choice_task__items")[0];

                // Add initial item separation (there needs to be > 1 subtask in a valid choice task)
                itemList.appendChild(createTaskSeparation()[0]);

                // Get, sort and add items
                $(choiceTask)
                    .data("subtaskIdsInitial")
                    .map(subTaskId => {
                        return block.find(`#item-${subTaskId}`)[0];
                    })
                    .sort((itemA, itemB) => {
                        // Ordering by index
                        return (
                            Number($(itemA).data("indexInitial")) -
                            Number($(itemB).data("indexInitial"))
                        );
                    })
                    .forEach(item => {
                        addItemBackToItemList(item, itemList);
                    });
            });
        }
        function addItemBackToItemList(item, itemList) {
            // Append item
            itemList.appendChild(item);

            // Append an item separation, there should always be (number of tasks) + 1 separations,
            // if there is at least one task
            itemList.appendChild(createTaskSeparation()[0]);

            // Append link
            let link = $(item).children("a");
            if (link.length > 0) {
                link.append($(item).find("a + .item__content"));
            }
        }
        function saveEditOrCreate() {
            const block = $(this).parent().parent();
            block.find(".task").attr("draggable", false);
            if (block.data("create")) {
                createBlock(block);
            } else {
                saveEdit(block);
            }
        }
        function validateBlock(block) {
            return [...block.find("input")].every(e => {
                e.reportValidity();
                return e.checkValidity();
            });
        }
        function validateChoiceTask(choiceTask) {
            // Validate that a choice task:
            // - Contains more than one sub-task
            // - Has minTasks < number of tasks

            const numTasks =
                choiceTask["newSubTasks"].length + choiceTask["updatedSubTasks"].length;
            const minTasks = parseInt(choiceTask["minTasks"]);
            const invalidNumTasks = numTasks <= 1;
            const minTasksTooHigh = minTasks >= numTasks;

            // If needed, display a warning pop up
            if (invalidNumTasks || minTasksTooHigh || minTasks <= 0) {
                const name = choiceTask["name"];
                let warning = "";

                if (invalidNumTasks) {
                    if (name !== "") {
                        warning =
                            `\"${name}\" contains ${numTasks} task(s) but it needs to contain ` +
                            "at least 2 tasks to choose from. Please adjust this.";
                    } else {
                        warning =
                            "Please make sure that choice tasks contain at least 2 tasks to choose from.";
                    }
                } else if (minTasksTooHigh) {
                    if (name !== "") {
                        warning =
                            `The number of tasks to complete for \"${name}\" is ${minTasks} but it contains ` +
                            `${numTasks} task(s). Please make sure that the number of tasks to ` +
                            "complete is smaller than the total number of tasks it contains.";
                    } else {
                        warning =
                            "Please make sure that the number of tasks to complete for a choice task " +
                            "is smaller than the total number of tasks it contains.";
                    }
                } else if (minTasks <= 0) {
                    if (name !== "") {
                        warning =
                            `The number of tasks to complete for \"${name}\" is ${minTasks} but it should be at` +
                            " least 1. Please adjust this.";
                    } else {
                        warning =
                            "Please make sure that the number of tasks to complete for a choice task is at least 1.";
                    }
                }

                // Show warning
                $("#choice-task-warning-text").text(warning);
                toggleOverlay("choice-task-warning-overlay");
                return false;
            }

            return true;
        }
        function validateItems(items) {
            return items
                .filter(item => item["delete"] === false && item["taskType"] === "ChoiceTask")
                .every(validateChoiceTask);
        }
        function serialiseBlockHeader(block) {
            const data = {};
            block
                .children(".block__header[data-edit='only']")
                .serializeArray()
                .forEach(field => {
                    if (field.name.includes(".")) {
                        const split = field.name.split(".");
                        if (!(split[0] in data)) {
                            data[split[0]] = {};
                        }
                        data[split[0]][split[1]] = field.value;
                    } else data[field.name] = field.value;
                });
            if (blockType === "skill") {
                data["requiredTaskIds"] = JSON.parse(
                    `[${block.find("[name='requiredTaskIds']").val()}]`
                );
            }
            return data;
        }

        function configureBlockEvents(block) {
            block.find(".block__edit").click(editBlock);
            block.find(".block__edit__cancel").click(cancelEditOrCreateBlock);
            block.find(".block__edit__save").click(saveEditOrCreate);
            block.find(".block__delete").click(deleteBlock);

            if (blockType === "skill") {
                block.find(".block__connect.from > button").click(connectFrom);
                block.find(".block__connect.to > button").click(connectTo);
            }

            let groupName = block.find(".block__group__name");
            groupName.mouseenter(mouseEnterGroup);
            groupName.mouseleave(mouseLeaveGroup);

            if (blockType === "skill") {
                block.find(".select__items button").click(selectItemIcon);
                block.find(".select__items > select").change(changeSelectedIcon);
                block.find("input[name='hidden']").click(toggleRequiredTasksButton);
                block.find("button[name='select-tasks']").click(selectRequiredTasks);
            }
            block.find(".item__delete").click(handleDeleteItemButton);
        }

        function saveEdit(block) {
            if (!validateBlock(block)) {
                return;
            }
            const data = serialiseBlockHeader(block);
            const items = serialiseBlockItems(block);
            if (!validateItems(items)) {
                return;
            }

            data["items"] = items.filter(item => !item.new && !item.delete);
            data["newItems"] = items.filter(item => item.new);
            data["removedItems"] = items.filter(item => item.delete).map(item => item.id);

            $.ajax({
                url: `/${blockType}`,
                method: "PATCH",
                contentType: "application/json",
                data: JSON.stringify(data),
                success: html => {
                    let element = $($("<div/>").append(html).children()[0]);
                    block.remove();
                    $("#circuit").append(element);
                    configureBlockEvents(element);
                },
            });
        }
        function selectRequiredTasks() {
            openTaskSelect($(this).siblings("[name='requiredTaskIds']"), ts => {
                if (ts.length >= 1) {
                    let number = ts.length === 1 ? "task" : "tasks";
                    $(this).text(`${ts.length} ${number} selected`);
                } else {
                    $(this).text("Select tasks");
                }
            });
        }
        function toggleRequiredTasksButton() {
            $(this).closest(".block").find("button[name='select-tasks']").toggleClass("hidden");
        }

        document.addEventListener("DOMContentLoaded", function () {
            $(".block__edit").click(editBlock);
            $(".block__edit__cancel").click(cancelEditOrCreateBlock);
            $(".block__edit__save").click(saveEditOrCreate);

            $("input[name='hidden']").click(toggleRequiredTasksButton);
            $("button[name='select-tasks']").click(selectRequiredTasks);
        });
    </script>
</html>
