<!--

    Skill Circuits
    Copyright (C) 2022 - Delft University of Technology

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

-->
<!DOCTYPE html>
<html
    lang="en"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
    <!--        th:data-id="${block.id}"-->
    <!--th:if="${level != 'module'} or ${block.completedRequiredTasks or canEdit or not block.hidden}"-->

    <dialog
        layout:fragment="bloated"
        class="bloated block"
        th:id="|block-${block.id}-bloated-overlay|"
        th:if="${level == 'module'and not canEdit}"
        style="padding: 0rem; position: fixed"
        th:data-group="${group.id}"
        th:data-create="${create}"
        th:with="
     parentIds = ${block instanceof T(nl.tudelft.skills.dto.view.BlockView)} ? ${block.parentIds} : ${{}},
     childIds = ${block instanceof T(nl.tudelft.skills.dto.view.BlockView)} ? ${block.childIds} : ${{}}"
        th:data-parents="${parentIds}"
        th:data-essential="${level == 'module'} ? ${block.essential} : ${null}"
        th:data-hidden="${level == 'module'} ? ${canEdit and block.hidden} : ${null}"
        th:data-checkpoint="${level == 'module'} ? ${block.checkpoint.id} : ${null}">
        <div style="padding: 1rem">
            <div th:id="|block-${block.id}-header|" class="block__header">
                <p
                    th:id="|block-${block.id}-group|"
                    class="block__group__name"
                    th:text="${group.name}"></p>
                <h2 class="block__name">
                    <span th:id="|block-${block.id}-name|" th:text="${block.name}"></span>
                </h2>
            </div>

            <div class="skill-paths">
                <div>
                    <span th:if="${#sets.contains(skillsModified, block)}" style="opacity: 80%">
                        Your path
                    </span>
                    <span
                        class="custom-path-name"
                        th:unless="${#sets.contains(skillsModified, block)}"
                        th:text="${@pathService.getPath(selectedPathId) == null ? 'No path' : @pathService.getPath(selectedPathId).name}"
                        style="color: grey"></span>

                    <ul data-edit="always" class="items custom-path-tasks">
                        <th:block th:each="item, iter : ${block.items}">
                            <th:block
                                th:if="${(item.visible and not #sets.contains(skillsModified, block))
                                                or (#sets.contains(skillsModified, block) and #sets.contains(tasksAdded, item))} ">
                                <li layout:replace="~{task/view :: item}"></li>
                            </th:block>
                        </th:block>
                        <h3 style="font-size: 0.8rem" class="empty-path-text">
                            This skill has no tasks in this path
                        </h3>
                    </ul>
                </div>
                <div>
                    <span style="opacity: 80%">Other paths</span>
                    <th:block th:each="path : ${@editionService.getPaths(circuit.edition.id)}">
                        <li layout:replace="~{path/view :: path}"></li>
                    </th:block>
                </div>
                <div>
                    <form th:action="@{|/person/reset/${block.id}|}" method="post">
                        <button
                            class="button reset-skill-button"
                            th:classappend="${#sets.contains(skillsModified, block)} ? '' : 'hidden'"
                            type="submit">
                            Reset
                        </button>
                    </form>
                </div>
            </div>

            <span class="block__info" th:if="${not block.essential}">Optional</span>
        </div>
    </dialog>

    <th:block layout:fragment="script">
        <div layout:replace="~{path/view :: script}"></div>
        <div layout:replace="~{task/inactiveview :: script}"></div>

        <script>
            // function mouseEnterGroup() {
            //     let submoduleId = $(this).parent().parent().data("group");
            //     $(`.block[data-group='${submoduleId}']`).addClass("highlighted");
            // }
            // function mouseLeaveGroup() {
            //     $(".block").removeClass("highlighted");
            // }

            // document.addEventListener("DOMContentLoaded", function () {
            //     let groupName = $(".block__group__name");
            //     groupName.mouseenter(mouseEnterGroup);
            //     groupName.mouseleave(mouseLeaveGroup);
            // });

            // functions for overlay
            function openBloatedSkill() {
                let blockId = $(this).data("id");
                toggleOverlay(`block-${blockId}-bloated-overlay`);
            }

            function closeSkillOverlay(id) {
                let overlay = document.getElementById(id);
                overlay.close();
            }

            document.addEventListener("DOMContentLoaded", function () {
                $(".block:not(.bloated)").click(openBloatedSkill);

                const myDialog = document.querySelectorAll(".block.bloated");
                myDialog.forEach(d =>
                    d.addEventListener("click", function (event) {
                        if (event.target === d) d.close();
                    })
                );

                // Open skill overlay if url has location information
                let openBlock = window.location.hash;
                if (openBlock != "") {
                    let blockOverlay = openBlock.substring(1) + "-bloated-overlay";
                    toggleOverlay(`${blockOverlay}`);
                }
            });
        </script>
    </th:block>
</html>
