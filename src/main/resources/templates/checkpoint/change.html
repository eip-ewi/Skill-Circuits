<!--

    Skill Circuits
    Copyright (C) 2022 - Delft University of Technology

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

-->
<!DOCTYPE html>
<html
    lang="en"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
    <div th:if="${canEdit}" layout:fragment="form" class="hidden" id="change-checkpoint-wrapper">
        <div id="change-checkpoint">
            <form class="checkpoint__form">
                <select
                    class="selectbox font_size_regular"
                    id="change-checkpoint-select"
                    name="checkpoint.id">
                    <option
                        th:each="checkpoint: ${circuit.checkpointsInEdition}"
                        th:value="${checkpoint.id}"
                        th:text="${checkpoint.name}"></option>
                </select>

                <button type="button" class="fa-solid fa-xmark"></button>
                <button type="submit" class="fa-solid fa-check"></button>
            </form>
        </div>
    </div>

    <script th:if="${canEdit}" layout:fragment="script">
        function changeCheckpoint() {
            const checkpointId = $(this).data("checkpoint");
            const checkpointDisplay = $(`#checkpoint-${checkpointId}-display`);

            $(`#checkpoint-${checkpointId}`).attr("draggable", false);
            checkpointDisplay.addClass("hidden");
            $(`#checkpoint-${checkpointId}-buttons`).addClass("hidden");

            const checkpointChanger = $("#change-checkpoint").clone();
            checkpointChanger.attr("id", `change-checkpoint-${checkpointId}`);
            checkpointChanger.children().eq(0).attr("id", `change-checkpoint-form-${checkpointId}`);
            checkpointChanger
                .children()
                .eq(0)
                .children()
                .eq(0)
                .attr("id", `change-checkpoint-select-${checkpointId}`);
            checkpointChanger
                .children()
                .eq(0)
                .children()
                .eq(1)
                .attr("id", `change-checkpoint-cancel-${checkpointId}`);

            $(`#checkpoint-${checkpointId}-body`).append(checkpointChanger);

            $(`#change-checkpoint-form-${checkpointId}`).submit(function (event) {
                const moduleId = $("#circuit").data("id");
                event.preventDefault();
                $.ajax({
                    type: "PUT",
                    url: "/checkpoint/change-checkpoint",
                    contentType: "application/json",
                    data: JSON.stringify({
                        moduleId: moduleId,
                        prevId: checkpointId,
                        newId: $(`#change-checkpoint-select-${checkpointId}`).val(),
                    }),
                    success: () => {
                        location.reload();
                    },
                    error: () => {},
                });
            });

            $(`#change-checkpoint-cancel-${checkpointId}`).click(function () {
                checkpointChanger.remove();
                $(`#checkpoint-${checkpointId}`).attr("draggable", true);
                $(`#checkpoint-${checkpointId}-display`).removeClass("hidden");
                $(`#checkpoint-${checkpointId}-buttons`).removeClass("hidden");
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            $(".checkpoint__body").mouseenter(() => {
                const checkpointSelect = $("#change-checkpoint-select");

                const checkpoints = $(".checkpoint:not(.ghost_checkpoint)").map((i, cp) =>
                    $(cp).attr("id").substring(11)
                );

                // need to retrieve available checkpoints
                let enabled_opts = [];
                checkpointSelect.find("option").each((i, opt) => {
                    opt = $(opt);
                    if ([...checkpoints].includes(opt.val())) {
                        opt.remove();
                    } else {
                        enabled_opts.push(opt.val());
                    }
                });

                const checkpointChange = $(".checkpoint__change");
                // checkpointChange may contain multiple elements, they all either have the class "hidden",
                // or they all do not
                if (enabled_opts.length > 0 && checkpointChange.hasClass("hidden")) {
                    checkpointSelect.val(enabled_opts[0]).change();
                    checkpointChange.removeClass("hidden");
                } else if (enabled_opts.length === 0) {
                    checkpointChange.addClass("hidden");
                }
            });

            $(".checkpoint__change").click(changeCheckpoint);
        });
    </script>
</html>
