<!--

    Skill Circuits
    Copyright (C) 2022 - Delft University of Technology

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

-->
<!DOCTYPE html>
<html
    lang="en"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
    <script layout:fragment="first-time">
        addEventListener("DOMContentLoaded", function () {
            $("#playlist-ft-ok")
                .off()
                .on("click", function () {
                    $("#playlist-ft").hide();
                });
        });
    </script>

    <script layout:fragment="create">
        function updateTotalEstTimeCr() {
            const checkboxes = document.querySelectorAll('input[id^="add-task-"]:checked');
            let totalEstTime = 0;

            checkboxes.forEach(function (checkbox) {
                totalEstTime += parseInt(checkbox.getAttribute("est-time"));
            });

            document.getElementById("total-est-time-cr").textContent = totalEstTime;
        }

        addEventListener("DOMContentLoaded", function () {
            const checkboxes = document.querySelectorAll('input[id^="add-task-"]');
            checkboxes.forEach(checkbox =>
                checkbox.addEventListener("change", updateTotalEstTimeCr)
            );
        });

        function createPlaylistTaskDTO(task) {
            const data = {};
            data.taskId = parseInt(task.id.replace("add-task-", ""));
            data.idx = parseInt(task.getAttribute("idx"));

            return data;
        }
        function getSelectedTasks() {
            const data = {};
            const playListVersionData = {};
            playListVersionData.taskCreates = [];
            const checkedTasks = document.querySelectorAll('input[id^="add-task-"]:checked');
            checkedTasks.forEach(task => {
                playListVersionData.taskCreates.push(createPlaylistTaskDTO(task));
            });
            playListVersionData.totalTime = parseInt(
                document.getElementById("total-est-time-cr").textContent
            );
            data.playlistVersionCreate = playListVersionData;
            return data;
        }

        document.addEventListener("DOMContentLoaded", function () {
            $("#create-playlist")
                .off("click")
                .on("click", function () {
                    const data = getSelectedTasks();

                    $.post({
                        url: "/playlist",
                        contentType: "application/json",
                        data: JSON.stringify(data),
                        success: () => {
                            sessionStorage.setItem("openPlDialog", "true");
                            location.reload();
                        },
                    });
                });
        });
        window.addEventListener("load", function () {
            if (sessionStorage.getItem("openPlDialog") === "true") {
                $("#playlist-button-c").trigger("focus");
                sessionStorage.setItem("openPlDialog", "false");
            }
        });
    </script>

    <script layout:fragment="play">
        //     Code for the timers in the playlist
        let timer;
        let startTime = null;
        let elapsedTime = 0;
        function startTimer() {
            document.getElementById("playlist-state").innerText = "playing";
            localStorage.setItem("playlist-state", "playing");

            timer = setInterval(updateTimer, 1000);
        }

        function pauseTimer() {
            document.getElementById("playlist-state").innerText = "paused";
            localStorage.setItem("playlist-state", "paused");
            clearInterval(timer);
        }

        function updateTimer() {
            elapsedTime++;
            let hours = Math.floor(elapsedTime / 60 / 60);
            let minutes = Math.floor((elapsedTime / 60) % 60);
            let seconds = Math.floor(elapsedTime % 60);

            document.getElementById("pl-timer-h").textContent = pad(hours);
            document.getElementById("pl-timer-min").textContent = pad(minutes);
            document.getElementById("pl-timer-sec").textContent = pad(seconds);

            saveTimer();
        }
        function pad(value) {
            return value < 10 ? "0" + value : value;
        }

        function saveTimer() {
            localStorage.setItem("plElapsedTime", elapsedTime);
        }

        function getSavedTimer() {
            elapsedTime = localStorage.getItem("plElapsedTime") || 0;
            const plState = localStorage.getItem("playlist-state") || "";
            if (plState === "paused") {
                document.getElementById("playlist-state").innerText = "paused";
            } else if (plState === "playing") {
                document.getElementById("playlist-state").innerText = "playing";
                startTimer();
            }
        }

        function deletePlaylist(buttonId) {
            const confirmation = window.confirm("Are you sure you want to delete this playlist");

            if (confirmation) {
                const playlistId = parseInt(buttonId.substring("playlist-delete-".length));
                $.ajax({
                    url: "/playlist/" + playlistId,
                    type: "DELETE",
                    success: () => {
                        sessionStorage.setItem("openPlDialog", "true");
                        location.reload();
                    },
                });
            }
        }

        addEventListener("DOMContentLoaded", function () {
            document.getElementById("playlist-play").addEventListener("click", startTimer);
            document.getElementById("playlist-pause").addEventListener("click", pauseTimer);
            document
                .querySelector('button[id^="playlist-delete-"]')
                .addEventListener("click", function () {
                    deletePlaylist(this.id);
                });
        });

        window.addEventListener("load", function () {
            getSavedTimer();
            if (sessionStorage.getItem("openPlDialog") === "true") {
                $("#playlist-button-c").trigger("focus");
                sessionStorage.setItem("openPlDialog", "false");
            }
        });
    </script>
</html>
