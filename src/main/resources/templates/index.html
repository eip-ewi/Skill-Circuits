<!--

    Skill Circuits
    Copyright (C) 2022 - Delft University of Technology

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

-->
<!DOCTYPE html>
<html
    lang="en"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{container}">
    <head>
        <link rel="stylesheet" th:href="@{/css/blocks.css}" />

        <title>Skill Circuits</title>
    </head>

    <body>
        <div
            layout:fragment="content"
            th:with="displayOwn = !${#lists.isEmpty(ownActive)} or !${#lists.isEmpty(ownFinished)} or !${#lists.isEmpty(managed)},
                        displayAvailable = !${#lists.isEmpty(availableActive)} or !${#lists.isEmpty(availableFinished)}">
            <h1>Welcome to Skill Circuits</h1>

            <!-- TODO check if this should be a form, only display if needed, show currently selected visually -->

            <div class="tabs" th:if="${displayOwn or displayAvailable}">
                <button
                    class="tab"
                    onclick="setCourseView('own')"
                    type="button"
                    th:if="${displayOwn}">
                    Your Courses
                </button>
                <button
                    class="tab"
                    onclick="setCourseView('available')"
                    type="button"
                    th:if="${displayAvailable}">
                    Available Courses
                </button>
            </div>

            <span
                th:if="${not displayOwn and not displayAvailable}"
                style="display: inline-block; margin-top: 1rem">
                There are currently
                <!-- spotless:off -->
                <b>no courses available</b>.
                <!-- spotless:on -->
            </span>

            <div id="own-courses" th:if="displayOwn">
                <h2 th:if="!${#lists.isEmpty(ownActive)}" style="margin-bottom: 0.5rem">
                    Active courses
                </h2>
                <div class="blocks" th:if="!${#lists.isEmpty(ownActive)}">
                    <th:block th:each="course : ${ownActive}">
                        <th:block>
                            <a
                                class="block"
                                th:href="@{|/edition/${@courseService.getLastStudentEditionForCourseOrLast(course.id)}|}">
                                <h2 th:text="${course.code}"></h2>
                                <h2 th:text="${course.name}"></h2>
                                <h3
                                    style="font-size: 0.8rem"
                                    th:text="|${completedSkillsPerCourse.get(course.id)} / ${@skillRepository.countBySubmoduleModuleEditionId(@courseService.getLastStudentEditionForCourseOrLast(course.id))} skills completed|"></h3>
                            </a>
                        </th:block>
                    </th:block>
                </div>

                <h2 th:if="!${#lists.isEmpty(ownFinished)}" style="margin-bottom: 0.5rem">
                    Finished courses
                </h2>
                <div class="blocks" th:if="!${#lists.isEmpty(ownFinished)}">
                    <th:block th:each="course : ${ownFinished}">
                        <th:block>
                            <a
                                class="block"
                                th:href="@{|/edition/${@courseService.getLastStudentEditionForCourseOrLast(course.id)}|}">
                                <h2 th:text="${course.code}"></h2>
                                <h2 th:text="${course.name}"></h2>
                                <h3
                                    style="font-size: 0.8rem"
                                    th:text="|${completedSkillsPerCourse.get(course.id)} / ${@skillRepository.countBySubmoduleModuleEditionId(@courseService.getLastStudentEditionForCourseOrLast(course.id))} skills completed|"></h3>
                            </a>
                        </th:block>
                    </th:block>
                </div>

                <h2 th:if="!${#lists.isEmpty(managed)}" style="margin-bottom: 0.5rem">
                    Managed courses
                </h2>
                <div class="blocks" th:if="!${#lists.isEmpty(managed)}">
                    <th:block th:each="course : ${managed}">
                        <th:block>
                            <a class="block" th:href="@{|/course/${course.id}|}">
                                <h2 th:text="${course.code}"></h2>
                                <h2 th:text="${course.name}"></h2>
                                <h3
                                    style="font-size: 0.8rem"
                                    th:text="|${@courseService.getNumberOfEditions(course.id)} editions|"></h3>
                            </a>
                        </th:block>
                    </th:block>
                </div>
            </div>

            <div
                id="available-courses"
                th:if="displayAvailable"
                th:aria-hidden="!displayOwn ? 'true' : ''"
                th:style="!displayOwn ? 'display: none' : ''">
                <h2 th:if="!${#lists.isEmpty(availableActive)}" style="margin-bottom: 0.5rem">
                    Active courses
                </h2>
                <div class="blocks" th:if="!${#lists.isEmpty(availableActive)}">
                    <th:block th:each="course : ${availableActive}">
                        <th:block>
                            <a
                                class="block"
                                th:href="@{|/edition/${@courseService.getLastEditionForCourse(course.id)}|}">
                                <h2 th:text="${course.code}"></h2>
                                <h2 th:text="${course.name}"></h2>
                                <h3
                                    style="font-size: 0.8rem"
                                    th:text="|${@skillRepository.countBySubmoduleModuleEditionId(@courseService.getLastEditionForCourse(course.id))} skills|"></h3>
                            </a>
                        </th:block>
                    </th:block>
                </div>

                <h2 th:if="!${#lists.isEmpty(availableFinished)}" style="margin-bottom: 0.5rem">
                    Finished courses
                </h2>
                <div class="blocks" th:if="!${#lists.isEmpty(availableFinished)}">
                    <th:block th:each="course : ${availableFinished}">
                        <th:block>
                            <a
                                class="block"
                                th:href="@{|/edition/${@courseService.getLastEditionForCourse(course.id)}|}">
                                <h2 th:text="${course.code}"></h2>
                                <h2 th:text="${course.name}"></h2>
                                <h3
                                    style="font-size: 0.8rem"
                                    th:text="|${@skillRepository.countBySubmoduleModuleEditionId(@courseService.getLastEditionForCourse(course.id))} skills|"></h3>
                            </a>
                        </th:block>
                    </th:block>
                </div>
            </div>
        </div>

        <script layout:fragment="script">
            /**
             * Sets the view of the courses to either "own" or "available". If no courses are visible,
             * or the view to set to is not visible, does nothing.
             *
             * @param view The view to set to ("own" or "available").
             */
            function setCourseView(view) {
                const ownCourses = $("#own-courses");
                const availableCourses = $("#available-courses");

                // If there is only one visible, view cannot be switched
                if (ownCourses.length === 0 || availableCourses === 0) {
                    return;
                }

                if (view === "own" && ownCourses.length > 0) {
                    ownCourses.css("display", "");
                    ownCourses.removeAttr("aria-hidden");
                    ownCourses.data("active", true);

                    availableCourses.css("display", "none");
                    availableCourses.attr("aria-hidden", "true");
                    availableCourses.data("active", false);
                } else if (view === "available" && availableCourses.length > 0) {
                    availableCourses.css("display", "");
                    availableCourses.removeAttr("aria-hidden");
                    availableCourses.data("active", true);

                    ownCourses.css("display", "none");
                    ownCourses.attr("aria-hidden", "true");
                    ownCourses.data("active", false);
                }
            }
        </script>
    </body>
</html>
