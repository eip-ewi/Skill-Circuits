<!--

    Skill Circuits
    Copyright (C) 2022 - Delft University of Technology

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

-->
<!DOCTYPE html>
<html
    lang="en"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
    <script th:if="${canEdit}" layout:fragment="script">
        let draggingTask = false;

        document.addEventListener(
            "dragstart",
            function (event) {
                if (event.target.classList.contains("task")) {
                    event.dataTransfer.setData("text/plain", event.target.id);
                    event.dataTransfer.dropEffect = "move";
                    $(event.target).css("opacity", "0.5");
                    $(circuit).attr("data-moving", "item");
                    draggingTask = true;
                }
            },
            false
        );
        document.addEventListener(
            "dragend",
            function (event) {
                if (event.target instanceof Element && event.target.classList.contains("task")) {
                    $(event.target).css("opacity", "");
                    draggingTask = false;
                    $(circuit).removeAttr("data-moving");
                }
            },
            false
        );

        document.addEventListener(
            "dragenter",
            function (event) {
                if (
                    event.target instanceof Element &&
                    event.target.classList.contains("item__separation") &&
                    draggingTask
                ) {
                    $(event.target).addClass("drag_over");
                }
            },
            false
        );
        document.addEventListener(
            "dragleave",
            function (event) {
                if (
                    event.target instanceof Element &&
                    event.target.classList.contains("item__separation")
                ) {
                    event.target.classList.remove("drag_over");
                }
            },
            false
        );

        document.addEventListener(
            "dragover",
            function (event) {
                if (event.target.classList.contains("item__separation") && draggingTask) {
                    event.preventDefault();
                    event.dataTransfer.dropEffect = "move";
                }
            },
            false
        );
        document.addEventListener(
            "drop",
            function (event) {
                if (
                    event.target instanceof Element &&
                    event.target.classList.contains("item__separation") &&
                    draggingTask
                ) {
                    event.preventDefault();

                    const task = $(`#${event.dataTransfer.getData("text/plain")}`);
                    const sepBeforeTask = task.next(".item__separation");
                    const targetSep = $(event.target);
                    const taskBeforeTarget = targetSep.next(".task");

                    const idxPrev = task.data("index");
                    const idxUpd =
                        taskBeforeTarget.length === 0 ? 0 : taskBeforeTarget.data("index") + 1;

                    if (idxPrev !== idxUpd) {
                        // Move task and one task separation element
                        targetSep.before(task);
                        task.before(sepBeforeTask);

                        // Update indices
                        const lowerIdx = idxPrev < idxUpd ? idxPrev : idxUpd;
                        const upperIdx = idxPrev < idxUpd ? idxUpd : idxPrev;
                        const addOrSubtract = idxPrev < idxUpd ? -1 : 1;
                        task.data("index", idxUpd);
                        task.siblings(".task").each(function () {
                            const idx = $(this).data("index");
                            if (idx >= lowerIdx && idx <= upperIdx) {
                                $(this).data("index", idx + addOrSubtract);
                            }
                        });
                    }

                    // Reset styling
                    task.css("opacity", "1");
                    targetSep.removeClass("drag_over");
                    $(circuit).removeAttr("data-moving");
                    draggingTask = false;
                }
            },
            false
        );
    </script>
</html>
