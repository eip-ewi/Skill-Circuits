<!--

    Skill Circuits
    Copyright (C) 2022 - Delft University of Technology

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

-->
<!DOCTYPE html>
<html
    lang="en"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
    <th:block layout:fragment="item">
        <th:block layout:replace="~{item/view :: item}">
            <th:block layout:fragment="item-content-element">
                <a
                    th:if="${item.link}"
                    th:href="${item.link}"
                    target="_blank"
                    th:id="|item-${item.id}-link|">
                    <th:block layout:replace="~{item/view :: item-content}"></th:block>
                </a>
                <th:block th:unless="${item.link}">
                    <th:block layout:replace="~{item/view :: item-content}"></th:block>
                </th:block>
            </th:block>
            <th:block layout:fragment="item-decoration">
                <button
                    class="circuit__button__symbol fa-solid fa-plus"
                    th:onclick="|addTaskToEditedSkill(${item.id})|"></button>

                <button
                    class="item__button"
                    data-staff="true"
                    disabled
                    th:text="${item.time}"></button>
            </th:block>
            <th:block layout:fragment="item-before-content">
                <span
                    th:id="|item-${item.id}-icon|"
                    th:class="|fa-solid fa-${item.type.icon}|"></span>
                <th:block layout:replace="~{task/edit :: icon}"></th:block>
            </th:block>
            <th:block layout:fragment="item-after-content">
                <span th:if="${canEdit}" th:text="|(${item.completedCount})|"></span>
                <span
                    th:if="${item.link}"
                    th:id="|item-${item.id}-link-icon|"
                    class="fa-solid fa-link always_visible"></span>
                <div class="hover_input" data-edit="only">
                    <input
                        th:data-initial="${item.link}"
                        placeholder="Task link"
                        data-edit="only"
                        aria-label="Task URL"
                        type="url"
                        name="link"
                        th:value="${item.link}" />
                    <span data-edit="only" class="fa-solid fa-link always_visible"></span>
                </div>
            </th:block>
        </th:block>
    </th:block>

    <script layout:fragment="script" th:inline="javascript">
        function addTaskToEditedSkill(taskId) {
            // Send custom path update if user is authenticate

            /*<![CDATA[*/
            const personId = /*[[${@authorisationService.authPerson?.id}]]*/ null;
            /*]]>*/
            if (personId !== null) {
                // If there is an authenticated person, also update on the server.
                $.ajax({
                    type: "PUT",
                    url: "/person/add/" + taskId,
                    processData: false,
                    contentType: "application/json",
                    success: () => {},
                });
            }

            // Remove task from right side
            let elems = document.querySelectorAll(`.item[data-item="${taskId}"`);

            let block = elems[0].closest(".block");
            elems.forEach(e => e.remove());
            // Add task to custom path)
            let leftUl = block.querySelector(".custom-path-tasks");

            // req task element (to be added to custom path)
            $.ajax({
                type: "GET",
                url: "/task/" + taskId,
                processData: false,
                contentType: "text/html",
                success: html => {
                    const task = $($("<div/>").append(html).children()[0]);
                    $(leftUl).append(task);
                },
            });
            // Change <PathName> to "Your Path"
            let customPathName = block.querySelector(".custom-path-name");
            if (customPathName != null) customPathName.textContent = "Your path";

            // Display Reset skill button
            block.querySelector(".reset-skill-button").classList.remove("hidden");

            // Hide icon from skill preview
            let icon = document.querySelector("#item-" + taskId + "-icon");
            console.log(icon);
            icon.classList.remove("hidden");
        }

        function removeTaskFromEditedSkill(taskId) {
            // Send custom path update if user is authenticated

            /*<![CDATA[*/
            const personId = /*[[${@authorisationService.authPerson?.id}]]*/ null;
            /*]]>*/
            if (personId !== null) {
                // If there is an authenticated person, also update on the server.
                $.ajax({
                    type: "PUT",
                    url: "/person/remove/" + taskId,
                    processData: false,
                    contentType: "application/json",
                    success: () => {},
                });
            }

            // Remove task from left side (from custom path)
            let elem = document.getElementById("item-" + taskId);

            let block = elem.closest(".block");
            let paths = elem.dataset.pathIds; //value("pathIds");

            elem.remove();
            // Add task on right side ("other paths")
            let rightPaths = block.getElementsByClassName("right-path");

            for (let rightPath of rightPaths) {
                if (paths.includes(rightPath.dataset.id)) {
                    let rightUl = rightPath.querySelector(".right-path-ul");

                    // req task element
                    $.ajax({
                        type: "GET",
                        url: "/task/" + taskId + "/right",
                        processData: false,
                        contentType: "text/html",
                        success: html => {
                            const task = $($("<div/>").append(html).children()[0]);
                            $(rightUl).append(task);
                        },
                    });
                }
            }

            // Change <PathName> to "Your Path"
            let customPathName = block.querySelector(".custom-path-name");
            if (customPathName != null) customPathName.textContent = "Your path";

            // Display Reset skill button
            block.querySelector(".reset-skill-button").classList.remove("hidden");

            // Hide icon from skill preview
            let icon = document.querySelector("#item-" + taskId + "-icon");
            console.log(icon);
            icon.classList.add("hidden");
        }
    </script>
</html>
