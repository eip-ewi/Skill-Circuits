<!--

    Skill Circuits
    Copyright (C) 2022 - Delft University of Technology

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

-->
<!DOCTYPE html>
<html
    lang="en"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
    <dialog
        layout:fragment="link-overlay"
        th:if="${@authorisationService.canEditEdition(edition.id)}"
        class="overlay link__overlay"
        id="link-overview-overlay">
        <h2>Edition link overview</h2>
        <button
            class="link__close fa-solid fa-xmark"
            title="Close overlay"
            aria-label="Close overlay"
            onclick="toggleOverlay('link-overview-overlay')"></button>

        <div class="link__filter">
            <form>
                <label for="type-filter">Filter by task type</label>
                <select id="type-filter" class="link__form">
                    <option value="All types" selected>All types</option>
                    <option
                        th:each="type : ${T(nl.tudelft.skills.model.TaskType).values()}"
                        th:value="${type}"
                        th:text="${#strings.capitalize(#strings.toLowerCase(type.name()))}"></option>
                </select>
            </form>

            <form id="searchbar-form">
                <label for="link-searchbar">Filter by link</label>
                <input id="link-searchbar" placeholder="Filter links" class="link__form" />
                <button type="submit">
                    <i class="fas fa-search"></i>
                </button>
            </form>
        </div>

        <div th:each="module : ${edition.modules}">
            <div th:if="${!#sets.isEmpty(module.tasksWithLinks)}" class="link__group">
                <h3 th:text="${module.name}" />
                <table class="link__table">
                    <!-- TODO implement better resizability -->
                    <tr>
                        <th style="min-width: 26rem"><b>Link</b></th>
                        <th style="min-width: 10rem"><b>Task</b></th>
                        <th style="min-width: 10rem"><b>Skill</b></th>
                        <th style="min-width: 10rem"><b>Submodule</b></th>
                    </tr>
                    <tr th:each="task : ${module.tasksWithLinks}">
                        <td>
                            <form th:id="'link-form' + ${task.id}" class="link_form">
                                <input
                                    th:id="'prev-link' + ${task.id}"
                                    type="hidden"
                                    th:value="${task.link}" />
                                <!-- TODO ability to delete the link fully (trashcan icon) -->
                                <input
                                    th:id="'link' + ${task.id}"
                                    th:value="${task.link}"
                                    type="url"
                                    aria-label="Change task URL"
                                    title="Change task URL"
                                    th:attr="onblur=|submitForm('${task.id}')|" />
                            </form>
                        </td>
                        <td>
                            <i th:class="|fa-solid fa-${task.type.icon}|"></i>
                            <span th:text="${task.name}"></span>
                        </td>
                        <td th:text="${task.skillName}"></td>
                        <td th:text="${task.submoduleName}"></td>
                    </tr>
                </table>
            </div>
        </div>
    </dialog>

    <script
        layout:fragment="script"
        th:if="${@authorisationService.canEditEdition(edition.id)}">
        document.addEventListener("DOMContentLoaded", function () {
            $(".link_form").on("submit", function (event) {
                event.preventDefault();
                const taskId = event.target.id.substring(9);

                if (!event.target.checkValidity()) {
                    const inputLink = $(`#link${taskId}`)[0];
                    inputLink.reportValidity();
                } else {
                    editLink(taskId);
                }
            });

            $("#searchbar-form").on("submit", function (event) {
                event.preventDefault();

                // TODO implement search by substring functionality
            });

            // TODO filter by type functionality
        });

        function submitForm(taskId) {
            $(`#link-form${taskId}`).submit();
        }

        function editLink(taskId) {
            const newLink = $(`#link${taskId}`);
            const prevLink = $(`#prev-link${taskId}`);

            if (prevLink.val() !== newLink.val()) {
                $.ajax({
                    url: "/task/change-link",
                    method: "PATCH",
                    contentType: "application/json",
                    data: JSON.stringify({
                        taskId: taskId,
                        newLink: newLink.val(),
                    }),
                    success: () => {
                        // Update previous value if successful
                        prevLink.val(newLink.val());
                    },
                    error: () => {
                        // Reset link field to previous value if unsuccessful
                        newLink.val(prevLink.val());
                    },
                });
            }
        }
    </script>
</html>
