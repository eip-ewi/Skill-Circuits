<!--

    Skill Circuits
    Copyright (C) 2022 - Delft University of Technology

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.

-->
<!DOCTYPE html>
<html
    lang="en"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
    <!-- TODO only display if authorised -->
    <dialog
        layout:fragment="link-overlay"
        class="overlay"
        style="height: 70vh; width: 70vw; padding: 1.4rem"
        id="link-overview-overlay">
        <h2>Edition link overview</h2>

        <div th:each="module : ${edition.modules}">
            <!-- TODO move styling to CSS file -->
            <div
                th:if="${!#sets.isEmpty(module.tasksWithLinks)}"
                style="
                    background-color: #e3e3e3;
                    padding: 0.5rem;
                    margin-top: 1rem;
                    width: min-content;
                ">
                <h3 th:text="${module.name}" style="margin-bottom: 0.5rem"></h3>
                <table style="border-spacing: 0 0.3rem">
                    <tr>
                        <th style="text-align: left; min-width: 28rem"><b>Link</b></th>
                        <th style="text-align: left; min-width: 10rem"><b>Task</b></th>
                        <th style="text-align: left; min-width: 10rem"><b>Skill</b></th>
                        <th style="text-align: left; min-width: 10rem"><b>Submodule</b></th>
                    </tr>
                    <tr th:each="task : ${module.tasksWithLinks}">
                        <td>
                            <input
                                th:id="'prev-link' + ${task.id}"
                                type="hidden"
                                th:value="${task.link}" />
                            <label th:for="'link' + ${task.id}">Link</label>
                            <input
                                th:id="'link' + ${task.id}"
                                th:value="${task.link}"
                                style="width: 25rem; border: none; padding: 0.2rem"
                                th:attr="onblur=|editLink('${task.id}')|" />
                        </td>
                        <td th:text="${task.name}"></td>
                        <td th:text="${task.skillName}"></td>
                        <td th:text="${task.submoduleName}"></td>
                    </tr>
                </table>
            </div>
        </div>
    </dialog>

    <!-- TODO only display if authorised -->
    <script layout:fragment="script">
        function editLink(taskId) {
            const newLink = $(`#link` + taskId);
            const prevLink = $(`#prev-link` + taskId);

            // TODO validate link format, close overlay on click
            if (prevLink.val() !== newLink.val()) {
                $.ajax({
                    url: "/task/change-link",
                    method: "PATCH",
                    contentType: "application/json",
                    data: JSON.stringify({
                        taskId: taskId,
                        newLink: newLink.val(),
                    }),
                    success: () => {
                        prevLink.val(newLink.val());
                    },
                    error: () => {
                        newLink.val(prevLink.val());
                    },
                });
            }
        }
    </script>
</html>
