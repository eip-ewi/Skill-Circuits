#
# Skill Circuits
# Copyright (C) 2025 - Delft University of Technology
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#

databaseChangeLog:
  # Introduce ordering
  - changeSet:
      id: 1659611816234-1
      author: ruben (generated)
      changes:
        - addColumn:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: idx
                  type: INTEGER
            tableName: task
  - changeSet:
      id: 1659611816234-migrate-task-ordering
      author: Ruben Backx
      changes:
        - sql:
            comment: Keep current task ordering (by id)
            sql: UPDATE task SET idx = id;
  # Hidden skills
  - changeSet:
      id: 1660912175253-1
      author: ruben (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_EC
                  name: required_tasks_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_EC
                  name: required_for_id
                  type: BIGINT
            tableName: task_required_for
  - changeSet:
      id: 1660912175253-2
      author: ruben (generated)
      changes:
        - addColumn:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: hidden
                  type: BOOLEAN
            tableName: skill
  - changeSet:
      id: 1660912175253-3
      author: ruben (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: required_tasks_id
            indexName: FKog5wjbi2d5d2f9i3kl7cyu58a_INDEX_E
            tableName: task_required_for
  - changeSet:
      id: 1660912175253-4
      author: ruben (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: required_for_id
            indexName: FKtjvvl1ice8hcviw4lstna196b_INDEX_E
            tableName: task_required_for
  - changeSet:
      id: 1660912175253-5
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: required_tasks_id
            baseTableName: task_required_for
            constraintName: FKog5wjbi2d5d2f9i3kl7cyu58a
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: task
            validate: true
  - changeSet:
      id: 1660912175253-6
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: required_for_id
            baseTableName: task_required_for
            constraintName: FKtjvvl1ice8hcviw4lstna196b
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: skill
            validate: true
  # External skills
  - changeSet:
      id: 1661766741710-1
      author: ruben (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_9
                  name: id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                  name: x_pos
                  type: INT
              - column:
                  constraints:
                    nullable: false
                  name: y_pos
                  type: INT
            tableName: abstract_skill
  - changeSet:
      id: 1661766741710-migrate-skill-positions
      author: Ruben Backx
      changes:
        - sql:
            comment: Migrate skill positions
            sql: INSERT INTO abstract_skill (id, x_pos, y_pos) SELECT id, x_pos, y_pos FROM skill;
  - changeSet:
      id: 1661766741710-2
      author: ruben (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_4A
                  name: children_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_4A
                  name: parents_id
                  type: BIGINT
            tableName: abstract_skill_parents
  - changeSet:
      id: 1661764054983-migrate-skill-parents
      author: Ruben Backx
      changes:
        - sql:
            comment: Migrate skill parents
            sql: INSERT INTO abstract_skill_parents SELECT * FROM skill_parents;
  - changeSet:
      id: 1661766741710-6
      author: ruben (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_FA
                  name: id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                  name: module_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                  name: skill_id
                  type: BIGINT
            tableName: external_skill
  - changeSet:
      id: 1661766741710-10
      author: ruben (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: module_id
            indexName: FK1qux3xj9lydkqa60yuhlno76j_INDEX_F
            tableName: external_skill
  - changeSet:
      id: 1661766741710-14
      author: ruben (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: skill_id
            indexName: FKaqmetn1jao3dox4bd66lx81a7_INDEX_F
            tableName: external_skill
  - changeSet:
      id: 1661766741710-15
      author: ruben (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: parents_id
            indexName: FKd5d1lbs5mpe1of1aq1svoi6ve_INDEX_4
            tableName: abstract_skill_parents
  - changeSet:
      id: 1661766741710-16
      author: ruben (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: children_id
            indexName: FKm8mjb7qnextnjh33sgpwsiqim_INDEX_4
            tableName: abstract_skill_parents
  - changeSet:
      id: 1661766741710-21
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: module_id
            baseTableName: external_skill
            constraintName: FK1qux3xj9lydkqa60yuhlno76j
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: scmodule
            validate: true
  - changeSet:
      id: 1661766741710-25
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: id
            baseTableName: external_skill
            constraintName: FK9tooj2x9oyumrjmqjlkv7i3om
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: abstract_skill
            validate: true
  - changeSet:
      id: 1661766741710-26
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: skill_id
            baseTableName: external_skill
            constraintName: FKaqmetn1jao3dox4bd66lx81a7
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: skill
            validate: true
  - changeSet:
      id: 1661766741710-27
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: parents_id
            baseTableName: abstract_skill_parents
            constraintName: FKd5d1lbs5mpe1of1aq1svoi6ve
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: abstract_skill
            validate: true
  - changeSet:
      id: 1661766741710-28
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: children_id
            baseTableName: abstract_skill_parents
            constraintName: FKm8mjb7qnextnjh33sgpwsiqim
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: abstract_skill
            validate: true
  - changeSet:
      id: 1661766741710-32
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: id
            baseTableName: skill
            constraintName: FKpgc19ygtewus63d76ogq7ltt0
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: abstract_skill
            validate: true
  - changeSet:
      id: 1661766741710-34
      author: ruben (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: skill_parents
            constraintName: FKi3rncw39bg0yvw2e79jkchrkl
  - changeSet:
      id: 1661766741710-35
      author: ruben (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: skill_parents
            constraintName: FKnb8ad4t5c3fy0olkqmj31n27e
  - changeSet:
      id: 1661766741710-36
      author: ruben (generated)
      changes:
        - dropTable:
            tableName: skill_parents
  - changeSet:
      id: 1661766741710-37
      author: ruben (generated)
      changes:
        - dropColumn:
            columnName: x_pos
            tableName: skill
  - changeSet:
      id: 1661766741710-38
      author: ruben (generated)
      changes:
        - dropColumn:
            columnName: y_pos
            tableName: skill
  # Paths
  - changeSet:
      id: 1666277687515-1
      author: ruben (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_2
                  name: id
                  type: BIGINT
              - column:
                  name: edition_id
                  type: BIGINT
              - column:
                  name: path_id
                  type: BIGINT
              - column:
                  name: person_id
                  type: BIGINT
            tableName: path_preference
  - changeSet:
      id: 1666277687515-2
      author: ruben (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_4B
                  name: tasks_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_4B
                  name: paths_id
                  type: BIGINT
            tableName: task_paths
  - changeSet:
      id: 1666277687515-3
      author: ruben (generated)
      changes:
        - addColumn:
            columns:
              - column:
                  name: default_path_id
                  type: BIGINT
            tableName: scedition
  - changeSet:
      id: 1666277687515-4
      author: ruben (generated)
      changes:
        - addColumn:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: edition_id
                  type: BIGINT
            tableName: path
  - changeSet:
      id: 1666277687515-5
      author: ruben (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: tasks_id
            indexName: FK38oua7on7grmm8n1suxy75km5_INDEX_4
            tableName: task_paths
  - changeSet:
      id: 1666277687515-6
      author: ruben (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: edition_id
            indexName: FK5ya45ljgxlk5ltbdf8japsbyd_INDEX_3
            tableName: path
  - changeSet:
      id: 1666277687515-7
      author: ruben (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: edition_id
            indexName: FK6n3tmsuu1xv03u260k7g44ac7_INDEX_2
            tableName: path_preference
  - changeSet:
      id: 1666277687515-8
      author: ruben (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: person_id
            indexName: FKftscxjndqe8rfewve36yor67a_INDEX_2
            tableName: path_preference
  - changeSet:
      id: 1666277687515-9
      author: ruben (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: path_id
            indexName: FKjny4cbic5teg6obff33bj36r2_INDEX_2
            tableName: path_preference
  - changeSet:
      id: 1666277687515-10
      author: ruben (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: paths_id
            indexName: FKl23e8jwownkl53dwh7c9bj5w6_INDEX_4
            tableName: task_paths
  - changeSet:
      id: 1666277687515-11
      author: ruben (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: default_path_id
            indexName: FKmh9dharmdw9id0ky3sectj1c1_INDEX_5
            tableName: scedition
  - changeSet:
      id: 1666277687515-12
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: tasks_id
            baseTableName: task_paths
            constraintName: FK38oua7on7grmm8n1suxy75km5
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: task
            validate: true
  - changeSet:
      id: 1666277687515-13
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: edition_id
            baseTableName: path
            constraintName: FK5ya45ljgxlk5ltbdf8japsbyd
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: scedition
            validate: true
  - changeSet:
      id: 1666277687515-14
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: edition_id
            baseTableName: path_preference
            constraintName: FK6n3tmsuu1xv03u260k7g44ac7
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: scedition
            validate: true
  - changeSet:
      id: 1666277687515-15
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: person_id
            baseTableName: path_preference
            constraintName: FKftscxjndqe8rfewve36yor67a
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: scperson
            validate: true
  - changeSet:
      id: 1666277687515-16
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: path_id
            baseTableName: path_preference
            constraintName: FKjny4cbic5teg6obff33bj36r2
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: path
            validate: true
  - changeSet:
      id: 1666277687515-17
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: paths_id
            baseTableName: task_paths
            constraintName: FKl23e8jwownkl53dwh7c9bj5w6
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: path
            validate: true
  - changeSet:
      id: 1666277687515-18
      author: ruben (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: default_path_id
            baseTableName: scedition
            constraintName: FKmh9dharmdw9id0ky3sectj1c1
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: path
            validate: true
  - changeSet:
      id: 1666277687515-19
      author: ruben (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: path_tasks
            constraintName: FK8d8e7lpvv6jxa6jkt1kexaq6j
  - changeSet:
      id: 1666277687515-20
      author: ruben (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: path_tasks
            constraintName: FKgk7imq9p338vghn5rno8d32ca
  - changeSet:
      id: 1666277687515-21
      author: ruben (generated)
      changes:
        - dropTable:
            tableName: path_tasks
  # Move task completion to separate table
  - changeSet:
      id: 1682666888978-1
      author: fanni (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_C9
                  name: id
                  type: BIGINT
              - column:
                  name: timestamp
                  type: TIMESTAMP
              - column:
                  constraints:
                    nullable: false
                  name: person_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                  name: task_id
                  type: BIGINT
            tableName: task_completion
  - changeSet:
      id: 1682666888978-2
      author: fanni (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: task_id
            indexName: FK2mq03rtqcy5jvlco1co1fco6a_INDEX_C
            tableName: task_completion
  - changeSet:
      id: 1682666888978-3
      author: fanni (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: person_id
            indexName: FK6l4isevvkwkbay4mgbqg7y91s_INDEX_C
            tableName: task_completion
  - changeSet:
      id: 1682666888978-4
      author: fanni (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: task_id
            baseTableName: task_completion
            constraintName: FK2mq03rtqcy5jvlco1co1fco6a
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: task
            validate: true
  - changeSet:
      id: 1682666888978-5
      author: fanni (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: person_id
            baseTableName: task_completion
            constraintName: FK6l4isevvkwkbay4mgbqg7y91s
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: scperson
            validate: true
  #  - changeSet:
  #      id: 1682666888978-create-task-completion-id-sequence
  #      author: Fanni Fiedrich
  #      changes:
  #        - createSequence:
  #            cycle: false
  #            incrementBy: 1
  #            minValue: 1
  #            maxValue: 9223372036854775807
  #            ordered: true
  #            sequenceName: completion_seq
  #            startValue: 1
  - changeSet:
      id: task-completion-auto-increment-mysql
      author: Ruben Backx
      dbms: mysql
      changes:
        - sql:
            comment: Add auto increment to ID of task_completion
            sql: ALTER TABLE task_completion MODIFY COLUMN id BIGINT AUTO_INCREMENT;
  - changeSet:
      id: task-completion-auto-increment-h2
      author: Ruben Backx
      dbms: h2
      changes:
        - sql:
            comment: Add auto increment to ID of task_completion
            sql: ALTER TABLE task_completion ALTER COLUMN id BIGINT AUTO_INCREMENT;
  - changeSet:
      id: 1682666888978-migrate-tasks-completed
      author: Fanni Fiedrich
      changes:
        - sql:
            comment: Migrate tasks completed
            sql: INSERT INTO task_completion (timestamp, person_id, task_id) SELECT NULL, persons_id, tasks_completed_id FROM scperson_tasks_completed;
  - changeSet:
      id: 1682666888978-6
      author: fanni (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: scperson_tasks_completed
            constraintName: FKrwsuhj88n1n0sigqwibq4dap1
  - changeSet:
      id: 1682666888978-7
      author: fanni (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: scperson_tasks_completed
            constraintName: FKtgiw4qnal6d91p8va4dvur1o4
  - changeSet:
      id: 1682666888978-8
      author: fanni (generated)
      changes:
        - dropTable:
            tableName: scperson_tasks_completed
  # Skills can remember the skill in previous edition
  - changeSet:
      id: 1683394188548-1
      author: fanni (generated)
      changes:
        - addColumn:
            columns:
              - column:
                  name: previous_edition_skill_id
                  type: BIGINT
            tableName: skill
  - changeSet:
      id: 1683394188548-2
      author: fanni (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: previous_edition_skill_id
            indexName: FKmo4sw73pk13vxtwcjejc0do8j_INDEX_6
            tableName: skill
  - changeSet:
      id: 1683394188548-3
      author: fanni (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: previous_edition_skill_id
            baseTableName: skill
            constraintName: FKmo4sw73pk13vxtwcjejc0do8j
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: skill
            validate: true
  # Create table for logging clicked links
  - changeSet:
      id: 1691506242366-1
      author: bakos (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_4C
                  name: id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                  name: timestamp
                  type: TIMESTAMP
              - column:
                  constraints:
                    nullable: false
                  name: person_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                  name: task_id
                  type: BIGINT
            tableName: clicked_link
  - changeSet:
      id: 1691506242366-2
      author: bakos (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: task_id
            indexName: FKjy82i90jv9tm04dy5lmdedv4t_INDEX_4
            tableName: clicked_link
  - changeSet:
      id: 1691506242366-3
      author: bakos (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: person_id
            indexName: FKpkdufyxedswqtr9wxbvxs4g09_INDEX_4
            tableName: clicked_link
  - changeSet:
      id: 1691506242366-4
      author: bakos (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: task_id
            baseTableName: clicked_link
            constraintName: FKjy82i90jv9tm04dy5lmdedv4t
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: task
            validate: true
  - changeSet:
      id: 1691506242366-5
      author: bakos (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: person_id
            baseTableName: clicked_link
            constraintName: FKpkdufyxedswqtr9wxbvxs4g09
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: scperson
            validate: true
  - changeSet:
      id: 1697897070404-1
      author: bakos (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_6F
                  name: id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                  name: version
                  type: VARCHAR(255)
              - column:
                  constraints:
                    nullable: false
                  name: person_id
                  type: BIGINT
            tableName: user_version
  - changeSet:
      id: 1697897070404-2
      author: bakos (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: person_id
            indexName: FK4hnnv70ddmpa33xy9ogk078t5_INDEX_6
            tableName: user_version
  - changeSet:
      id: 1697897070404-3
      author: bakos (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: person_id
            baseTableName: user_version
            constraintName: FK4hnnv70ddmpa33xy9ogk078t5
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: scperson
            validate: true

  # Customise tasks in skill
  - changeSet:
      id: 1684509725437-1
      author: mars (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_21
                  name: person_modified_skill_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_21
                  name: skills_modified_id
                  type: BIGINT
            tableName: scperson_skills_modified
  - changeSet:
      id: 1684509725437-2
      author: mars (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_F8
                  name: persons_that_added_task_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_F8
                  name: tasks_added_id
                  type: BIGINT
            tableName: scperson_tasks_added
  - changeSet:
      id: 1684509725437-3
      author: mars (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: skills_modified_id
            indexName: FKeoxxf3njxk8axo1mjbfu3m7hp_INDEX_2
            tableName: scperson_skills_modified
  - changeSet:
      id: 1684509725437-4
      author: mars (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: persons_that_added_task_id
            indexName: FKn444l2wfkopnym2dgvimw9ojo_INDEX_F
            tableName: scperson_tasks_added
  - changeSet:
      id: 1684509725437-5
      author: mars (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: tasks_added_id
            indexName: FKrtd50gfy2hcf3h69oobl6klh3_INDEX_F
            tableName: scperson_tasks_added
  - changeSet:
      id: 1684509725437-6
      author: mars (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: person_modified_skill_id
            indexName: FKsullxuw6a27c690fnuopkhape_INDEX_2
            tableName: scperson_skills_modified
  - changeSet:
      id: 1684509725437-7
      author: mars (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: skills_modified_id
            baseTableName: scperson_skills_modified
            constraintName: FKeoxxf3njxk8axo1mjbfu3m7hp
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: skill
            validate: true
  - changeSet:
      id: 1684509725437-8
      author: mars (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: persons_that_added_task_id
            baseTableName: scperson_tasks_added
            constraintName: FKn444l2wfkopnym2dgvimw9ojo
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: scperson
            validate: true
  - changeSet:
      id: 1684509725437-9
      author: mars (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: tasks_added_id
            baseTableName: scperson_tasks_added
            constraintName: FKrtd50gfy2hcf3h69oobl6klh3
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: task
            validate: true
  - changeSet:
      id: 1684509725437-10
      author: mars (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: person_modified_skill_id
            baseTableName: scperson_skills_modified
            constraintName: FKsullxuw6a27c690fnuopkhape
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: scperson
            validate: true
#  Playlist feature Q3 2023-2024, 0.0
  - changeSet:
      id: 1707577509701-1
      author: rngla (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_2D
                  name: id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                  name: opt_in
                  type: TIMESTAMP
              - column:
                  name: opt_out
                  type: TIMESTAMP
              - column:
                  constraints:
                    nullable: false
                  name: person_id
                  type: BIGINT
            tableName: research_participant
  - changeSet:
      id: 1707577509701-2
      author: rngla (generated)
      changes:
        - addUniqueConstraint:
            columnNames: person_id
            constraintName: UK_64dt4vh7o4k7vbrfgmu5qrql3
            tableName: research_participant
  - changeSet:
      id: 1707577509701-3
      author: rngla (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: person_id
            baseTableName: research_participant
            constraintName: FKnoawfap41wy1l5xgop178dgfq
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: scperson
            validate: true
#  Playlist feature Q3 2023-2024, 1.0
  - changeSet:
      id: 1709215030386-1
      author: rngla (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_7
                  name: id
                  type: BIGINT
              - column:
                  name: active
                  type: BOOLEAN
              - column:
                  constraints:
                    nullable: false
                  name: created
                  type: TIMESTAMP
              - column:
                  name: deleted
                  type: TIMESTAMP
              - column:
                  name: state
                  type: INT
              - column:
                  constraints:
                    nullable: false
                  name: latest_version_id
                  type: BIGINT
              - column:
                  name: participant_id
                  type: BIGINT
            tableName: playlist
  - changeSet:
      id: 1709215030386-2
      author: rngla (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_67
                  name: id
                  type: BIGINT
            tableName: playlist_checkpoint
  - changeSet:
      id: 1709215030386-3
      author: rngla (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_30A
                  name: id
                  type: BIGINT
              - column:
                  name: completed
                  type: BOOLEAN
              - column:
                  name: completion_time
                  type: INT
              - column:
                  constraints:
                    nullable: false
                  name: idx
                  type: INT
              - column:
                  name: started
                  type: TIMESTAMP
              - column:
                  constraints:
                    nullable: false
                  name: task_id
                  type: BIGINT
              - column:
                  name: participant_id
                  type: BIGINT
            tableName: playlist_task
  - changeSet:
      id: 1709215030386-4
      author: rngla (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_C7
                  name: id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                  name: elapsed_time
                  type: INT
              - column:
                  constraints:
                    nullable: false
                  name: elapsed_time_updated
                  type: TIMESTAMP
              - column:
                  constraints:
                    nullable: false
                  name: estimated_time
                  type: INT
              - column:
                  name: playlist_id
                  type: BIGINT
            tableName: playlist_version
  - changeSet:
      id: 1709215030386-5
      author: rngla (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_47
                  name: playlist_version_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_47
                  name: tasks_id
                  type: BIGINT
            tableName: playlist_version_tasks
  - changeSet:
      id: 1709215030386-6
      author: rngla (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_C81
                  name: id
                  type: BIGINT
              - column:
                  name: rating
                  type: INT
              - column:
                  name: time_stamp
                  type: TIMESTAMP
              - column:
                  name: person_id
                  type: BIGINT
            tableName: rating
  - changeSet:
      id: 1709215030386-7
      author: rngla (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_97
                  name: id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                  name: interaction
                  type: INT
              - column:
                  constraints:
                    nullable: false
                  name: time_stamp
                  type: TIMESTAMP
              - column:
                  name: person_id
                  type: BIGINT
            tableName: usage_data
  - changeSet:
      id: 1709215030386-8
      author: rngla (generated)
      changes:
        - addColumn:
            columns:
              - column:
                  name: clear_data
                  type: BOOLEAN
            tableName: research_participant
  - changeSet:
      id: 1709215030386-9
      author: rngla (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: playlist_id
            indexName: FK4w6jaqt7cvu7iwny8g9m4nkmt_INDEX_C
            tableName: playlist_version
  - changeSet:
      id: 1709215030386-10
      author: rngla (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: participant_id
            indexName: FKf2v7empym2b0ihs0pbgwsaacy_INDEX_7
            tableName: playlist
  - changeSet:
      id: 1709215030386-11
      author: rngla (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: playlist_version_id
            indexName: FKg86mm73xna9i47a9xgslj2wt7_INDEX_4
            tableName: playlist_version_tasks
  - changeSet:
      id: 1709215030386-12
      author: rngla (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: person_id
            indexName: FKkikh18arv5eujtv2f26ykhndp_INDEX_9
            tableName: usage_data
  - changeSet:
      id: 1709215030386-13
      author: rngla (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: latest_version_id
            indexName: FKlieu928p8mfbqm4uktqgq8sm0_INDEX_7
            tableName: playlist
  - changeSet:
      id: 1709215030386-14
      author: rngla (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: tasks_id
            indexName: FKqpn919ahm5gx28u94dgm87d0p_INDEX_4
            tableName: playlist_version_tasks
  - changeSet:
      id: 1709215030386-15
      author: rngla (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: person_id
            indexName: FKry4lvm3c8fwioeum2fm5y0x3j_INDEX_C
            tableName: rating
  - changeSet:
      id: 1709215030386-16
      author: rngla (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: participant_id
            indexName: FKsnvc6w8exgm3r5tc5dh3us6jf_INDEX_3
            tableName: playlist_task
  - changeSet:
      id: 1709215030386-17
      author: rngla (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: playlist_id
            baseTableName: playlist_version
            constraintName: FK4w6jaqt7cvu7iwny8g9m4nkmt
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: playlist
            validate: true
  - changeSet:
      id: 1709215030386-18
      author: rngla (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: participant_id
            baseTableName: playlist
            constraintName: FKf2v7empym2b0ihs0pbgwsaacy
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: research_participant
            validate: true
  - changeSet:
      id: 1709215030386-19
      author: rngla (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: playlist_version_id
            baseTableName: playlist_version_tasks
            constraintName: FKg86mm73xna9i47a9xgslj2wt7
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: playlist_version
            validate: true
  - changeSet:
      id: 1709215030386-20
      author: rngla (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: person_id
            baseTableName: usage_data
            constraintName: FKkikh18arv5eujtv2f26ykhndp
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: research_participant
            validate: true
  - changeSet:
      id: 1709215030386-21
      author: rngla (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: latest_version_id
            baseTableName: playlist
            constraintName: FKlieu928p8mfbqm4uktqgq8sm0
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: playlist_version
            validate: true
  - changeSet:
      id: 1709215030386-22
      author: rngla (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: tasks_id
            baseTableName: playlist_version_tasks
            constraintName: FKqpn919ahm5gx28u94dgm87d0p
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: playlist_task
            validate: true
  - changeSet:
      id: 1709215030386-23
      author: rngla (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: person_id
            baseTableName: rating
            constraintName: FKry4lvm3c8fwioeum2fm5y0x3j
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: research_participant
            validate: true
  - changeSet:
      id: 1709215030386-24
      author: rngla (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: participant_id
            baseTableName: playlist_task
            constraintName: FKsnvc6w8exgm3r5tc5dh3us6jf
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: research_participant
            validate: true
# Store a student's revealed skills
  - changeSet:
      id: 1705055255520-1
      author: rngla (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_37
                  name: person_revealed_skill_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_37
                  name: skills_revealed_id
                  type: BIGINT
            tableName: scperson_skills_revealed
  - changeSet:
      id: 1705055255520-2
      author: rngla (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: person_revealed_skill_id
            indexName: FKp7gdtsvvdi338qlau7nik7fma_INDEX_3
            tableName: scperson_skills_revealed
  - changeSet:
      id: 1705055255520-3
      author: rngla (generated)
      changes:
        - createIndex:
            columns:
              - column:
                  name: skills_revealed_id
            indexName: FKsex8nmu8xkxti3oaa367ldp_INDEX_3
            tableName: scperson_skills_revealed
  - changeSet:
      id: 1705055255520-4
      author: rngla (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: person_revealed_skill_id
            baseTableName: scperson_skills_revealed
            constraintName: FKp7gdtsvvdi338qlau7nik7fma
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: scperson
            validate: true
  - changeSet:
      id: 1705055255520-5
      author: rngla (generated)
      changes:
        - addForeignKeyConstraint:
            baseColumnNames: skills_revealed_id
            baseTableName: scperson_skills_revealed
            constraintName: FKsex8nmu8xkxti3oaa367ldp
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: skill
            validate: true
# Removing Playlist feature tables
  - changeSet:
      id: 1725284460843-1
      author: rngla (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: playlist_version
            constraintName: FK4w6jaqt7cvu7iwny8g9m4nkmt
  - changeSet:
      id: 1725284460843-2
      author: rngla (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: playlist
            constraintName: FKf2v7empym2b0ihs0pbgwsaacy
  - changeSet:
      id: 1725284460843-3
      author: rngla (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: playlist_version_tasks
            constraintName: FKg86mm73xna9i47a9xgslj2wt7
  - changeSet:
      id: 1725284460843-4
      author: rngla (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: usage_data
            constraintName: FKkikh18arv5eujtv2f26ykhndp
  - changeSet:
      id: 1725284460843-5
      author: rngla (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: playlist
            constraintName: FKlieu928p8mfbqm4uktqgq8sm0
  - changeSet:
      id: 1725284460843-6
      author: rngla (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: research_participant
            constraintName: FKnoawfap41wy1l5xgop178dgfq
  - changeSet:
      id: 1725284460843-7
      author: rngla (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: playlist_version_tasks
            constraintName: FKqpn919ahm5gx28u94dgm87d0p
  - changeSet:
      id: 1725284460843-8
      author: rngla (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: rating
            constraintName: FKry4lvm3c8fwioeum2fm5y0x3j
  - changeSet:
      id: 1725284460843-9
      author: rngla (generated)
      changes:
        - dropForeignKeyConstraint:
            baseTableName: playlist_task
            constraintName: FKsnvc6w8exgm3r5tc5dh3us6jf
  - changeSet:
      id: 1725284460843-10
      author: rngla (generated)
      changes:
        - dropUniqueConstraint:
            constraintName: UK_64dt4vh7o4k7vbrfgmu5qrql3
            tableName: research_participant
  - changeSet:
      id: 1725284460843-11
      author: rngla (generated)
      changes:
        - dropTable:
            tableName: playlist
  - changeSet:
      id: 1725284460843-12
      author: rngla (generated)
      changes:
        - dropTable:
            tableName: playlist_checkpoint
  - changeSet:
      id: 1725284460843-13
      author: rngla (generated)
      changes:
        - dropTable:
            tableName: playlist_task
  - changeSet:
      id: 1725284460843-14
      author: rngla (generated)
      changes:
        - dropTable:
            tableName: playlist_version
  - changeSet:
      id: 1725284460843-15
      author: rngla (generated)
      changes:
        - dropTable:
            tableName: playlist_version_tasks
  - changeSet:
      id: 1725284460843-16
      author: rngla (generated)
      changes:
        - dropTable:
            tableName: rating
  - changeSet:
      id: 1725284460843-17
      author: rngla (generated)
      changes:
        - dropTable:
            tableName: research_participant
  - changeSet:
      id: 1725284460843-18
      author: rngla (generated)
      changes:
        - dropTable:
            tableName: usage_data

# Refactor tasks for introduction of choice tasks
  - changeSet:
      id: introduce-choice-tasks
      author: Fanni Fiedrich
      changes:
        - createTable:
            columns:
              - column:
                  name: min_tasks
                  type: INT
              - column:
                  name: name
                  type: VARCHAR(255)
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_CHOICE_TASK_ID
                  name: id
                  type: BIGINT
            tableName: choice_task
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: choice_task_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                  name: tasks_id
                  type: BIGINT
            tableName: choice_task_tasks
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_REGULAR_TASK_ID
                  name: id
                  type: BIGINT
            tableName: regular_task
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: CONSTRAINT_TASK_INFO_ID
                  name: id
                  type: BIGINT
              - column:
                  name: link
                  type: VARCHAR(255)
              - column:
                  name: name
                  type: VARCHAR(255)
              - column:
                  name: time
                  type: INT
              - column:
                  constraints:
                    nullable: false
                  name: type
                  type: INT
              - column:
                  constraints:
                    nullable: false
                  name: task_id
                  type: BIGINT
            tableName: task_info
        - addUniqueConstraint:
            columnNames: tasks_id
            constraintName: UK_b5x1p3iemd3y0hkt8mjwadutj
            tableName: choice_task_tasks
        - createIndex:
            columns:
              - column:
                  name: choice_task_id
            indexName: FK23ix52b2jn1gfm9skaoo2vuqn_INDEX_4
            tableName: choice_task_tasks
        - createIndex:
            columns:
              - column:
                  name: task_id
            indexName: FKer9mcdyqf63005umklqiv1kia_INDEX_A
            tableName: task_info
        - sql:
            comment: Migrate tasks
            sql: INSERT INTO regular_task SELECT id FROM task;
        - sql:
            dbms: mysql
            comment: Add auto increment to ID of task_info
            sql: ALTER TABLE task_info MODIFY COLUMN id BIGINT AUTO_INCREMENT;
        - sql:
            dbms: h2
            comment: Add auto increment to ID of task_info
            sql: ALTER TABLE task_info ALTER COLUMN id BIGINT AUTO_INCREMENT;
        - sql:
            comment: Migrate task infos
            sql: INSERT INTO task_info (link, name, time, type, task_id) SELECT link, name, time, type, id FROM task;
        - addForeignKeyConstraint:
            baseColumnNames: choice_task_id
            baseTableName: choice_task_tasks
            constraintName: FK23ix52b2jn1gfm9skaoo2vuqn
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: choice_task
            validate: true
        - addForeignKeyConstraint:
            baseColumnNames: task_id
            baseTableName: clicked_link
            constraintName: FK6r0ixb6exd6dof00vqfpgeocw
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: regular_task
            validate: true
        - addForeignKeyConstraint:
            baseColumnNames: task_id
            baseTableName: task_completion
            constraintName: FKa6pqa4rvd2kxcrw2tfqeq9fwn
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: regular_task
            validate: true
        - addForeignKeyConstraint:
            baseColumnNames: task_id
            baseTableName: task_info
            constraintName: FKer9mcdyqf63005umklqiv1kia
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: task
            validate: true
        - addForeignKeyConstraint:
            baseColumnNames: tasks_id
            baseTableName: choice_task_tasks
            constraintName: FKeu3tpj1jlur65d5ov5ei8j343
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: task_info
            validate: true
        - addForeignKeyConstraint:
            baseColumnNames: id
            baseTableName: regular_task
            constraintName: FKh24gyn1h2ckorlayh66sjwk2b
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: task
            validate: true
        - addForeignKeyConstraint:
            baseColumnNames: id
            baseTableName: choice_task
            constraintName: FKhf21xrs4mfvuq5k8nnajh6rnw
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: task
            validate: true
        - dropForeignKeyConstraint:
            baseTableName: task_completion
            constraintName: FK2mq03rtqcy5jvlco1co1fco6a
        - dropForeignKeyConstraint:
            baseTableName: clicked_link
            constraintName: FKjy82i90jv9tm04dy5lmdedv4t
        - dropColumn:
            columnName: link
            tableName: task
        - dropColumn:
            columnName: name
            tableName: task
        - dropColumn:
            columnName: time
            tableName: task
        - dropColumn:
            columnName: type
            tableName: task
  # Change task info hold a regular task instead of a task
  - changeSet:
      id: map-task-info-to-regular-task
      author: Fanni Fiedrich
      changes:
        - dropForeignKeyConstraint:
            baseTableName: task_info
            constraintName: FKer9mcdyqf63005umklqiv1kia
        - addForeignKeyConstraint:
            baseColumnNames: task_id
            baseTableName: task_info
            constraintName: FK668gtd2qb2rvcmu9ugwtw56yy
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: regular_task
            validate: true


  ####################
  # Version 2526.0.0 #
  ####################

  #
  # Remove inventories
  #
  - changeSet:
      id: remove-inventories
      author: ruben
      changes:
        - dropForeignKeyConstraint:
            baseTableName: inventory_inventory_items
            constraintName: FK4gwfo42iccppofjxx7yndoh78 # inventory_inventory_items.inventory_id -> inventory.id
        - dropForeignKeyConstraint:
            baseTableName: inventory_inventory_items
            constraintName: FKshbh4txmrh1choxhfe89hqqnq # inventory_inventory_items.items_id -> inventory_item.id
        - dropForeignKeyConstraint:
            baseTableName: scperson
            constraintName: FKo3yf33nocqc5g4krhvo1oq8dy # scperson.inventory_id -> inventory.id
        - dropColumn:
            columnName: inventory_id
            tableName: scperson
        - dropTable:
            tableName: inventory_inventory_items
        - dropTable:
            tableName: inventory
        - dropTable:
            tableName: inventory_item

  #
  # Remove default paths
  #
  - changeSet:
      id: remove-default-paths
      author: ruben
      changes:
        - dropForeignKeyConstraint:
            baseTableName: scedition
            constraintName: FKmh9dharmdw9id0ky3sectj1c1 # scedition.default_path_id -> path.id
        - dropColumn:
            columnName: default_path_id
            tableName: scedition

  #
  # Profiles get a 'View mode'
  #
  - changeSet:
      id: add-view-mode
      author: ruben
      changes:
        - addColumn:
            columns:
              - column:
                  defaultValue: VIEWER
                  name: view_mode
                  type: ENUM('VIEWER', 'EDITOR', 'ADMIN')
            tableName: scperson

  #
  # External skills can also be essential
  #
  - changeSet:
      id: external-skills-essential
      author: ruben
      changes:
        - addColumn:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: essential
                  type: BIT
                  defaultValueBoolean: false
            tableName: abstract_skill
        # move essentiality from skills to abstract skills
        - sql:
            dbms: mariadb,mysql
            sql: update abstract_skill inner join skill on abstract_skill.id = skill.id set abstract_skill.essential = skill.essential;
        - dropColumn:
            columnName: essential
            tableName: skill

  #
  # Paths get a description
  #
  - changeSet:
      id: add-path-description
      author: ruben
      changes:
        - addColumn:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: description
                  type: TEXT
            tableName: path

  #
  # Blocks do not specify their rows anymore
  #
  - changeSet:
      id: remove-block-rows
      author: ruben
      changes:
        - dropColumn:
            columnName: y_pos
            tableName: abstract_skill
        - dropColumn:
            columnName: y_pos
            tableName: submodule

  #
  # Blocks can be unplaced by having a null column
  #
  - changeSet:
      id: allow-null-columns
      author: ruben
      changes:
        - dropNotNullConstraint:
            columnDataType: int
            columnName: x_pos
            tableName: abstract_skill
        - dropNotNullConstraint:
            columnDataType: int
            columnName: x_pos
            tableName: submodule

  #
  # Checkpoints can be null
  #
  - changeSet:
      id: allow-null-checkpoints
      author: ruben
      changes:
        - dropNotNullConstraint:
            columnDataType: bigint
            columnName: checkpoint_id
            tableName: skill

  #
  # Task types are now stored as strings
  #
  - changeSet:
      id: store-task-type-as-strings
      author: ruben
      changes:
        - renameColumn:
            oldColumnName: type
            newColumnName: type_index
            columnDataType: int
            tableName: task_info
        - addColumn:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: type
                  type: ENUM('READING', 'VIDEO', 'QUIZ', 'IMPLEMENTATION', 'EXERCISE', 'COLLABORATION', 'EXPERIMENT', 'CLASSROOM')
                  defaultValue: READING
            tableName: task_info
        - sql:
            sql: update task_info set type = 'READING' where type_index = 0;
        - sql:
            sql: update task_info set type = 'VIDEO' where type_index = 1;
        - sql:
            sql: update task_info set type = 'QUIZ' where type_index = 2;
        - sql:
            sql: update task_info set type = 'IMPLEMENTATION' where type_index = 3;
        - sql:
            sql: update task_info set type = 'EXERCISE' where type_index = 4;
        - sql:
            sql: update task_info set type = 'COLLABORATION' where type_index = 5;
        - sql:
            sql: update task_info set type = 'EXPERIMENT' where type_index = 6;
        - sql:
            sql: update task_info set type = 'CLASSROOM' where type_index = 7;
        - dropColumn:
            columnName: type_index
            tableName: task_info

  #
  # Clicked links are linked to task info
  #
  - changeSet:
      id: link-clicked-links-to-task-info
      author: ruben
      changes:
        - dropForeignKeyConstraint:
            baseTableName: clicked_link
            constraintName: FK6r0ixb6exd6dof00vqfpgeocw
        - sql:
            dbms: mysql,mariadb
            sql: update clicked_link inner join regular_task on clicked_link.task_id = regular_task.id inner join task_info on task_info.task_id = regular_task.id set clicked_link.task_id = task_info.id;
        - addForeignKeyConstraint:
            baseColumnNames: task_id
            baseTableName: clicked_link
            constraintName: fk_clicked_link_to_task_info
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: task_info
            validate: true

  #
  # Task completion is linked to task info
  #
  - changeSet:
      id: link-task-completion-to-task-info
      author: ruben
      changes:
        - dropForeignKeyConstraint:
            baseTableName: task_completion
            constraintName: FKa6pqa4rvd2kxcrw2tfqeq9fwn
        - sql:
            dbms: mysql,mariadb
            sql: update task_completion inner join regular_task on task_completion.task_id = regular_task.id inner join task_info on task_info.task_id = regular_task.id set task_completion.task_id = task_info.id;
        - addForeignKeyConstraint:
            baseColumnNames: task_id
            baseTableName: task_completion
            constraintName: fk_task_completion_to_task_info
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: task_info
            validate: true

  #
  # No keeping track of skills modified anymore, only tasks
  #
  - changeSet:
      id: remove-skills-modified
      author: ruben
      changes:
        - dropForeignKeyConstraint:
            baseTableName: scperson_skills_modified
            constraintName: FKeoxxf3njxk8axo1mjbfu3m7hp
        - dropForeignKeyConstraint:
            baseTableName: scperson_skills_modified
            constraintName: FKsullxuw6a27c690fnuopkhape
        - dropTable:
            tableName: scperson_skills_modified

  #
  # Add bookmarks
  #
  - changeSet:
      id: add-bookmarks
      author: ruben
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                  name: id
                  type: BIGINT
              - column:
                  name: name
                  type: VARCHAR(255)
              - column:
                  name: person_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                  name: dtype
                  type: VARCHAR(31)
              - column:
                  constraints:
                    nullable: false
                  name: last_modified
                  type: TIMESTAMP
            tableName: bookmark_list
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                  name: skills_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                  name: on_lists_id
                  type: BIGINT
            tableName: bookmark_list_skills
        - createIndex:
            columns:
              - column:
                  name: skills_id
            indexName: fk_bookmark_list_to_skills
            tableName: bookmark_list_skills
        - addForeignKeyConstraint:
            baseColumnNames: skills_id
            baseTableName: bookmark_list_skills
            constraintName: fk_bookmark_list_to_skills
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: skill
            validate: true
        - createIndex:
            columns:
              - column:
                  name: on_lists_id
            indexName: fk_skill_to_on_bookmark_list
            tableName: bookmark_list_skills
        - addForeignKeyConstraint:
            baseColumnNames: on_lists_id
            baseTableName: bookmark_list_skills
            constraintName: fk_skill_to_on_bookmark_list
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: bookmark_list
            validate: true
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                  name: tasks_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                  name: on_lists_id
                  type: BIGINT
            tableName: bookmark_list_tasks
        - createIndex:
            columns:
              - column:
                  name: tasks_id
            indexName: fk_bookmark_list_to_tasks
            tableName: bookmark_list_tasks
        - addForeignKeyConstraint:
            baseColumnNames: tasks_id
            baseTableName: bookmark_list_tasks
            constraintName: fk_bookmark_list_to_tasks
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: task_info
            validate: true
        - createIndex:
            columns:
              - column:
                  name: on_lists_id
            indexName: fk_task_to_on_bookmark_list
            tableName: bookmark_list_tasks
        - addForeignKeyConstraint:
            baseColumnNames: on_lists_id
            baseTableName: bookmark_list_tasks
            constraintName: fk_task_to_on_bookmark_list
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: bookmark_list
            validate: true
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                  name: choice_tasks_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                  name: on_lists_id
                  type: BIGINT
            tableName: bookmark_list_choice_tasks
        - createIndex:
            columns:
              - column:
                  name: choice_tasks_id
            indexName: fk_bookmark_list_to_choice_tasks
            tableName: bookmark_list_choice_tasks
        - addForeignKeyConstraint:
            baseColumnNames: choice_tasks_id
            baseTableName: bookmark_list_choice_tasks
            constraintName: fk_bookmark_list_to_choice_tasks
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: choice_task
            validate: true
        - createIndex:
            columns:
              - column:
                  name: on_lists_id
            indexName: fk_choice_task_to_on_bookmark_list
            tableName: bookmark_list_choice_tasks
        - addForeignKeyConstraint:
            baseColumnNames: on_lists_id
            baseTableName: bookmark_list_choice_tasks
            constraintName: fk_choice_task_to_on_bookmark_list
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: bookmark_list
            validate: true

  #
  # Bookmark lists for hidden skills
  #
  - changeSet:
      id: add-bookmark-lists-for-hidden-skills
      author: ruben (generated)
      changes:
        - addColumn:
            columns:
              - column:
                  name: requirements_id
                  type: BIGINT
            tableName: skill
        - createIndex:
            columns:
              - column:
                  name: requirements_id
            indexName: fk_hidden_skill_to_requirements
            tableName: skill
        - addForeignKeyConstraint:
            baseColumnNames: requirements_id
            baseTableName: skill
            constraintName: fk_hidden_skill_to_requirements
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: bookmark_list
            validate: true
        - dropForeignKeyConstraint:
            baseTableName: task_required_for
            constraintName: FKog5wjbi2d5d2f9i3kl7cyu58a
        - dropForeignKeyConstraint:
            baseTableName: task_required_for
            constraintName: FKtjvvl1ice8hcviw4lstna196b
        # Add a column to bookmark list, keeping track for which hidden skill it is
        - addColumn:
            columns:
              - column:
                  name: hidden_skill_id
                  type: BIGINT
            tableName: bookmark_list
        # Add a bookmark list for every hidden skill
        - sql:
            sql: insert into bookmark_list (dtype, last_modified, hidden_skill_id) select 'HiddenSkillBookmarkList', NOW(), id from skill where skill.hidden = true;
        # Connect the hidden skills to their lists
        - sql:
            dbms: mysql,mariadb
            sql: update skill inner join bookmark_list on bookmark_list.hidden_skill_id = skill.id set skill.requirements_id = bookmark_list.id;
        # Remove temporary column
        - dropColumn:
            columnName: hidden_skill_id
            tableName: bookmark_list
        # Update the old requirements table to use task info IDs
        - sql:
            dbms: mysql,mariadb
            sql: update task_required_for inner join regular_task on regular_task.id = task_required_for.required_tasks_id inner join task_info on task_info.task_id = regular_task.id set task_required_for.required_tasks_id = task_info.id;
        # Add all requirements to the correct list
        - sql:
            dbms: mysql,mariadb
            sql: insert into bookmark_list_tasks select task_required_for.required_tasks_id, skill.requirements_id from task_required_for inner join skill on task_required_for.required_for_id = skill.id;
        - dropTable:
            tableName: task_required_for

  #
  # Add edition editor role
  #
  - changeSet:
      id: add-edition-editors
      author: ruben
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                  name: editors_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                  name: editor_in_editions_id
                  type: BIGINT
            tableName: scedition_editors
        - createIndex:
            columns:
              - column:
                  name: editor_in_editions_id
            indexName: fk_edition_to_editors
            tableName: scedition_editors
        - addForeignKeyConstraint:
            baseColumnNames: editor_in_editions_id
            baseTableName: scedition_editors
            constraintName: fk_edition_to_editors
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: scedition
            validate: true
        - createIndex:
            columns:
              - column:
                  name: editors_id
            indexName: fk_editor_to_editions
            tableName: scedition_editors
        - addForeignKeyConstraint:
            baseColumnNames: editors_id
            baseTableName: scedition_editors
            constraintName: fk_editor_to_editions
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: scperson
            validate: true

  #
  # Add ordering to paths
  #
  - changeSet:
      id: order-paths
      author: ruben
      changes:
        - addColumn:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: idx
                  type: INT
                  defaultValueNumeric: 0
            tableName: path

  #
  # Task info can also be a subtask of a choice task, in which case it has no regular task
  #
  - changeSet:
      id: connect-choice-task-to-task-info
      author: ruben
      changes:
        - dropNotNullConstraint:
            columnDataType: bigint
            columnName: task_id
            tableName: task_info
        - addColumn:
            columns:
              - column:
                  name: choice_task_id
                  type: BIGINT
            tableName: task_info
        - createIndex:
            columns:
              - column:
                  name: choice_task_id
            indexName: fk_subtask_to_choice_task
            tableName: task_info
        - addForeignKeyConstraint:
            baseColumnNames: choice_task_id
            baseTableName: task_info
            constraintName: fk_subtask_to_choice_task
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: choice_task
            validate: true

  #
  # Choice task names are blank, not null
  #
  - changeSet:
      id: disallow-null-task-names
      author: ruben
      changes:
        - addNotNullConstraint:
            columnDataType: varchar(255)
            columnName: name
            tableName: choice_task
            validate: true

  #
  # Change sequence to auto increment ID generation
  #
  - changeSet:
      id: use-auto-increment-ids
      author: ruben (generated)
      changes:
        - sql:
            sql: drop table if exists hibernate_sequence;
        - sql:
            dbms: mysql,mariadb
            sql: SET FOREIGN_KEY_CHECKS=0;
        - addAutoIncrement:
            columnName: id
            columnDataType: bigint
            tableName: abstract_skill
        - addAutoIncrement:
            columnName: id
            columnDataType: bigint
            tableName: checkpoint
        - addAutoIncrement:
            columnName: id
            columnDataType: bigint
            tableName: clicked_link
        - addAutoIncrement:
            columnName: id
            columnDataType: bigint
            tableName: path
        - addAutoIncrement:
            columnName: id
            columnDataType: bigint
            tableName: path_preference
        - addAutoIncrement:
            columnName: id
            columnDataType: bigint
            tableName: scmodule
        - addAutoIncrement:
            columnName: id
            columnDataType: bigint
            tableName: submodule
        - addAutoIncrement:
            columnName: id
            columnDataType: bigint
            tableName: task
        - addAutoIncrement:
            columnName: id
            columnDataType: bigint
            tableName: track
        - addAutoIncrement:
            columnName: id
            columnDataType: bigint
            tableName: user_version
        - sql:
            dbms: mysql,mariadb
            sql: SET FOREIGN_KEY_CHECKS=1;

  #
  # Add a tasks removed table
  #
  - changeSet:
      id: add-tasks-removed
      author: ruben
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                  name: persons_that_removed_task_id
                  type: BIGINT
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                  name: tasks_removed_id
                  type: BIGINT
            tableName: scperson_tasks_removed
        - createIndex:
            columns:
              - column:
                  name: tasks_removed_id
            indexName: fk_person_to_removed_task
            tableName: scperson_tasks_removed
        - addForeignKeyConstraint:
            baseColumnNames: tasks_removed_id
            baseTableName: scperson_tasks_removed
            constraintName: fk_person_to_removed_task
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: task
            validate: true
        - createIndex:
            columns:
              - column:
                  name: persons_that_removed_task_id
            indexName: fk_removed_task_to_person
            tableName: scperson_tasks_removed
        - addForeignKeyConstraint:
            baseColumnNames: persons_that_removed_task_id
            baseTableName: scperson_tasks_removed
            constraintName: fk_removed_task_to_person
            deferrable: false
            initiallyDeferred: false
            onDelete: RESTRICT
            onUpdate: RESTRICT
            referencedColumnNames: id
            referencedTableName: scperson
            validate: true

  #
  # Everyone gets a 'new bookmarks' list
  #
  - changeSet:
      id: new-bookmarks-for-existing-users
      author: ruben
      changes:
        - sql:
            sql: insert into bookmark_list (person_id, name, dtype, last_modified) select id, 'My bookmarks', 'PersonalBookmarkList', NOW() from scperson;

  #
  # Reverse task ordering
  #
  - changeSet:
      id: reverse-task-ordering
      author: ruben
      changes:
        - sql:
            dbms: mariadb,mysql
            sql: update task join (select id, row_number() over (partition by skill_id order by idx desc) - 1 as idx from task) as updated on task.id = updated.id set task.idx = updated.idx;

  #
  # Booleans are bits now in MySQL
  #
  - changeSet:
      id: booleans-to-bits-mysql
      author: ruben
      changes:
        - modifyDataType:
            tableName: scedition
            columnName: is_visible
            newDataType: bit
        - modifyDataType:
            tableName: skill
            columnName: hidden
            newDataType: bit

  #
  # Store personal preferences for theme and blurring
  #
  - changeSet:
      id: setup-personal-preferences
      author: fanni
      changes:
        - addColumn:
            columns:
              - column:
                  name: blur_blocks
                  type: BOOLEAN # TODO: should this be "bit" now?
            tableName: scperson
        - addColumn:
            columns:
              - column:
                  name: theme
                  type: ENUM('DARK', 'LIGHT', 'NOSTALGIA')
            tableName: scperson
        - sql:
            sql: update scperson set blur_blocks = true;
        - sql:
            sql: update scperson set theme = 'LIGHT';